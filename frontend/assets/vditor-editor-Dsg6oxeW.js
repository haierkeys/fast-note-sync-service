import{r as e,u as t,j as r}from"./vendor-CXOLE99F.js";import{V as n}from"./vendor-editor-CJ7nnwr6.js";import{u as a,e as l}from"./index-CC45s5kh.js";const o=e.forwardRef(({value:o,onChange:i,readOnly:c=!1,placeholder:u,vault:s="",fileLinks:d={},initialMode:m="sv"},p)=>{const{resolvedTheme:f}=a(),{i18n:h}=t(),v=e.useRef(null),g=e.useRef(null),k=e.useRef(o),[b,w]=e.useState(!1),$=e.useRef({vault:s,fileLinks:d,token:localStorage.getItem("token")||""});$.current={vault:s,fileLinks:d,token:localStorage.getItem("token")||""};const R=e.useCallback(()=>{const e=h.language;return e.startsWith("zh")?"zh_CN":e.startsWith("ja")?"ja_JP":e.startsWith("ko")?"ko_KR":"en_US"},[h.language]);return e.useImperativeHandle(p,()=>({getValue:()=>b&&g.current?g.current.getValue():k.current,setValue:e=>{k.current=e,b&&g.current&&g.current.setValue(e)},exportPDF:()=>{b&&g.current&&g.current.tip("PDF å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...",2e3)},exportHTML:()=>{if(b&&g.current){const e=g.current.getHTML(),t=new Blob([`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Export</title></head><body>${e}</body></html>`],{type:"text/html"}),r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download="export.html",n.click(),URL.revokeObjectURL(r)}}}),[b]),e.useEffect(()=>{if(!v.current)return;const e=new n(v.current,{value:k.current,theme:"dark"===f?"dark":"classic",mode:"sv",lang:R(),placeholder:u||"",height:"100%",cache:{enable:!1},toolbar:c?[]:["headings","bold","italic","strike","link","|","list","ordered-list","check","quote","|","code","inline-code","table","line","|","undo","redo","|","outline","edit-mode","preview","fullscreen","|","export"],counter:{enable:!1,type:"text"},outline:{enable:!0,position:"right"},upload:{accept:"image/*",handler:e=>g.current?(e.forEach(e=>{var t;const r=`![[${e.name}]]`;null==(t=g.current)||t.insertValue(r)}),null):null},preview:{actions:[],transform:e=>{const{vault:t,fileLinks:r,token:n}=$.current;return function(e,t,r,n){return e?e.replace(/!\[\[([^\]]+)\]\]/g,(e,a)=>{const o=a.split("|"),i=o[0].split("#")[0].trim(),c=r[i]||i,u=o.slice(1),s=`${l.API_URL}/api/file?vault=${encodeURIComponent(t)}&path=${encodeURIComponent(c)}&token=${encodeURIComponent(n)}`,d=c.toLowerCase(),m=/\.(png|jpg|jpeg|gif|svg|webp|bmp)$/i.test(d),p=/\.(mp4|webm|ogg|mov)$/i.test(d),f=/\.(mp3|wav|ogg|m4a|flac)$/i.test(d);if(m){let e="";if(u[0]){const t=u[0].match(/^(\d+)/);t&&(e=` width="${t[1]}"`)}return`<img src="${s}" alt="${i}"${e} />`}return p?`<video src="${s}" controls style="max-width:100%"></video>`:f?`<audio src="${s}" controls></audio>`:`<a href="${s}" target="_blank">ðŸ“Ž ${i}</a>`}):e}(e,t,r,n)},hljs:{enable:!0,lineNumber:!0,style:"native"},markdown:{sanitize:!1}},input:e=>{k.current=e,null==i||i(e)},after:()=>{var t;if(g.current=e,w(!0),c&&e.disabled(),"preview"===m){const e=null==(t=v.current)?void 0:t.querySelector('.vditor-toolbar [data-type="preview"]');e&&e.click()}}});return()=>{w(!1),g.current&&(g.current.destroy(),g.current=null)}},[]),e.useEffect(()=>{b&&g.current&&g.current.setTheme("dark"===f?"dark":"classic","dark"===f?"dark":"light","dark"===f?"native":"github")},[f,b]),e.useEffect(()=>{b&&g.current&&o!==k.current&&(k.current=o,g.current.setValue(o))},[o,b]),e.useEffect(()=>{b&&g.current&&(c?g.current.disabled():g.current.enable())},[c,b]),r.jsx("div",{ref:v,className:"vditor-container h-full "+("preview"===m?"vditor-container--preview-only":"")})});o.displayName="VditorEditor";export{o as VditorEditor};

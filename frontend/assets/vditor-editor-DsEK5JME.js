import{r as e,w as t,j as r}from"./vendor-CePkgVYi.js";import{V as n}from"./vendor-vditor-xmyhtb0-.js";import{r as o,e as a}from"./index-BFc3BmsD.js";import"./vendor-ui-BwPMR9gB.js";import"./vendor-icons-D3bVgkGi.js";import"./vendor-lottie-Cgk9p7OH.js";import"./vendor-animation-Cs3gejBo.js";const l=e.forwardRef(({value:l,onChange:i,readOnly:c=!1,placeholder:u,vault:s="",fileLinks:d={},initialMode:m="sv"},p)=>{const{resolvedTheme:f}=o(),{t:v,i18n:h}=t(),g=e.useRef(null),k=e.useRef(null),b=e.useRef(l),[w,$]=e.useState(!1),j=e.useRef({vault:s,fileLinks:d,token:localStorage.getItem("token")||""});j.current={vault:s,fileLinks:d,token:localStorage.getItem("token")||""};const R=e.useCallback(()=>{const e=h.language;return e.startsWith("zh")?"zh_CN":e.startsWith("ja")?"ja_JP":e.startsWith("ko")?"ko_KR":"en_US"},[h.language]);return e.useImperativeHandle(p,()=>({getValue:()=>w&&k.current?k.current.getValue():b.current,setValue:e=>{b.current=e,w&&k.current&&k.current.setValue(e)},exportPDF:()=>{w&&k.current&&k.current.tip(v("ui.note.exportPdfPlanned"),2e3)},exportHTML:()=>{if(w&&k.current){const e=k.current.getHTML(),t=new Blob([`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Export</title></head><body>${e}</body></html>`],{type:"text/html"}),r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download="export.html",n.click(),URL.revokeObjectURL(r)}}}),[w,v]),e.useEffect(()=>{if(!g.current)return;const e=new n(g.current,{value:b.current,theme:"dark"===f?"dark":"classic",mode:"sv",lang:R(),placeholder:u||"",height:"100%",cache:{enable:!1},toolbar:c?[]:["headings","bold","italic","strike","link","|","list","ordered-list","check","quote","|","code","inline-code","table","line","|","undo","redo","|","outline","edit-mode","preview","fullscreen","|","export"],counter:{enable:!1,type:"text"},outline:{enable:!0,position:"right"},upload:{accept:"image/*",handler:e=>k.current?(e.forEach(e=>{var t;const r=`![[${e.name}]]`;null==(t=k.current)||t.insertValue(r)}),null):null},preview:{actions:[],transform:e=>{const{vault:t,fileLinks:r,token:n}=j.current;return function(e,t,r,n){return e?e.replace(/!\[\[([^\]]+)\]\]/g,(e,o)=>{const l=o.split("|"),i=l[0].split("#")[0].trim(),c=r[i]||i,u=l.slice(1),s=`${a.API_URL}/api/file?vault=${encodeURIComponent(t)}&path=${encodeURIComponent(c)}&token=${encodeURIComponent(n)}`,d=c.toLowerCase(),m=/\.(png|jpg|jpeg|gif|svg|webp|bmp)$/i.test(d),p=/\.(mp4|webm|ogg|mov)$/i.test(d),f=/\.(mp3|wav|ogg|m4a|flac)$/i.test(d);if(m){let e="";if(u[0]){const t=u[0].match(/^(\d+)/);t&&(e=` width="${t[1]}"`)}return`<img src="${s}" alt="${i}"${e} />`}return p?`<video src="${s}" controls style="max-width:100%"></video>`:f?`<audio src="${s}" controls></audio>`:`<a href="${s}" target="_blank">ðŸ“Ž ${i}</a>`}):e}(e,t,r,n)},hljs:{enable:!0,lineNumber:!0,style:"native"},markdown:{sanitize:!1}},input:e=>{b.current=e,null==i||i(e)},after:()=>{var t;if(k.current=e,$(!0),c&&e.disabled(),"preview"===m){const e=null==(t=g.current)?void 0:t.querySelector('.vditor-toolbar [data-type="preview"]');e&&e.click()}}});return()=>{$(!1),k.current&&(k.current.destroy(),k.current=null)}},[]),e.useEffect(()=>{w&&k.current&&k.current.setTheme("dark"===f?"dark":"classic","dark"===f?"dark":"light","dark"===f?"native":"github")},[f,w]),e.useEffect(()=>{w&&k.current&&l!==b.current&&(b.current=l,k.current.setValue(l))},[l,w]),e.useEffect(()=>{w&&k.current&&(c?k.current.disabled():k.current.enable())},[c,w]),r.jsx("div",{ref:g,className:"vditor-container h-full "+("preview"===m?"vditor-container--preview-only":"")})});l.displayName="VditorEditor";export{l as VditorEditor};
